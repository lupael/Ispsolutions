name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  integration:
    name: Run Integration Tests with Docker
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, pdo_mysql, bcmath, soap, intl, gd, exif, iconv
        coverage: none

    - name: Install PHP Dependencies
      run: composer install --no-interaction --prefer-dist

    - name: Copy .env
      run: cp .env.example .env

    - name: Start Docker Services
      run: |
        docker compose up -d --build
        
    - name: Wait for Services to be Ready
      run: |
        echo "Waiting for services to be healthy..."
        timeout=120
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          app_health=$(docker inspect --format='{{.State.Health.Status}}' ispsolution-app 2>/dev/null || echo "starting")
          db_health=$(docker inspect --format='{{.State.Health.Status}}' ispsolution-db 2>/dev/null || echo "starting")
          radius_health=$(docker inspect --format='{{.State.Health.Status}}' ispsolution-radius-db 2>/dev/null || echo "starting")
          
          echo "App: $app_health, DB: $db_health, Radius: $radius_health ($elapsed/$timeout seconds)"
          
          if [ "$app_health" = "healthy" ] && [ "$db_health" = "healthy" ] && [ "$radius_health" = "healthy" ]; then
            echo "All services are healthy!"
            break
          fi
          
          if [ "$app_health" = "unhealthy" ]; then
            echo "App container is unhealthy, checking logs..."
            docker compose logs app | tail -50
            exit 1
          fi
          
          sleep 5
          elapsed=$((elapsed + 5))
        done
        
        if [ $elapsed -ge $timeout ]; then
          echo "Timeout waiting for services"
          docker compose ps
          docker compose logs app
          docker compose logs db
          docker compose logs radius-db
          exit 1
        fi
        
    - name: Verify and Install Dependencies
      run: |
        echo "Verifying dependencies..."
        
        # Check if vendor exists
        if ! docker compose exec -T app test -d vendor; then
          echo "Installing PHP dependencies..."
          docker compose exec -T app composer install --no-interaction --prefer-dist
        fi
        
        # Create node_modules directory and fix permissions as root
        echo "Ensuring node_modules directory exists with proper permissions..."
        docker compose exec -T -u root app sh -c "mkdir -p node_modules && chown -R www-data:www-data node_modules"
        
        # Check if node_modules exists
        if ! docker compose exec -T app test -d node_modules; then
          echo "Installing NPM dependencies..."
          docker compose exec -T app npm ci
        else
          echo "NPM dependencies already installed, verifying vite..."
          if ! docker compose exec -T app test -f node_modules/.bin/vite; then
            echo "Vite not found, reinstalling NPM dependencies..."
            docker compose exec -T app npm ci
          fi
        fi
        
        echo "Dependencies verified:"
        docker compose exec -T app ls -la vendor/ | head -5
        docker compose exec -T app ls -la node_modules/ | head -5

    - name: Generate Application Key
      run: docker compose exec -T app php artisan key:generate

    - name: Build Assets
      run: docker compose exec -T app npm run build

    - name: Run Migrations
      run: |
        docker compose exec -T app php artisan migrate --force
        docker compose exec -T app php artisan migrate --database=radius --path=database/migrations/radius --force

    - name: Seed Database
      run: |
        docker compose exec -T app php artisan db:seed --class=RoleSeeder --force
        docker compose exec -T app php artisan db:seed --class=ServicePackageSeeder --force

    - name: Run Integration Tests
      run: docker compose exec -T app php artisan test --testsuite=Integration

    - name: Test IPAM Service
      run: |
        docker compose exec -T app php artisan test --filter=IpamIntegrationTest

    - name: Test RADIUS Service
      run: |
        docker compose exec -T app php artisan test --filter=RadiusIntegrationTest

    - name: Test MikroTik Service
      run: |
        docker compose exec -T app php artisan test --filter=MikrotikIntegrationTest

    - name: Test API Endpoints
      run: |
        docker compose exec -T app php artisan test --testsuite=Feature --filter=Api

    - name: Show Logs on Failure
      if: failure()
      run: |
        docker compose logs app
        docker compose logs db
        docker compose logs radius-db

    - name: Stop Docker Services
      if: always()
      run: docker compose down -v
