# Reseller Feature Guide

## Overview

The Reseller feature enables ISPs to create a hierarchical business model where approved resellers can manage their own customer accounts and earn commissions on revenue generated by their child accounts.

## Key Features

- **Reseller Signup Workflow**: Potential resellers can apply through a dedicated signup form
- **Approval System**: Admin review and approval process with customizable commission rates
- **Parent-Child Relationships**: Hierarchical account structure for managing sub-customers
- **Commission Tracking**: Automatic calculation of reseller commissions based on child account revenue
- **Reseller Dashboard**: Dedicated dashboard showing child accounts, revenue, and commissions
- **Permission Management**: Granular control over what resellers can and cannot do

## Architecture

### Database Schema

```php
// users table additions
'parent_id' => 'bigint unsigned nullable',  // Reference to parent reseller
'is_reseller' => 'boolean default false',   // Reseller flag
'reseller_status' => 'string',              // pending, approved, rejected
'commission_rate' => 'decimal(5,4)',        // Commission rate (e.g., 0.1500 for 15%)
'reseller_application_data' => 'json',      // Application details
'reseller_approved_at' => 'timestamp',
'reseller_approved_by' => 'bigint unsigned',
'reseller_rejected_at' => 'timestamp',
'reseller_rejected_by' => 'bigint unsigned',
'reseller_rejection_reason' => 'text',
```

### Models

- **User Model**: Extended with `childAccounts()` and `parent()` relationships
- **Relationships**:
  - `parent()`: BelongsTo relationship to parent user
  - `childAccounts()`: HasMany relationship to child users

### Services

- **ResellerBillingService**: Handles commission calculations and revenue reporting
  - `calculateChildAccountsRevenue()`: Calculate total revenue from child accounts
  - `generateCommissionReport()`: Generate detailed commission reports
  - `getAllResellersCommission()`: Get commission data for all resellers
  - `payCommission()`: Record commission payments

### Controllers

- **ResellerSignupController**: Manages reseller application workflow
  - `showSignupForm()`: Display signup form
  - `signup()`: Process application
  - `listApplications()`: Admin view of pending applications
  - `approveApplication()`: Approve reseller
  - `rejectApplication()`: Reject application
  - `dashboard()`: Reseller dashboard
  - `commissionReport()`: Commission report view

### Policies

- **CustomerPolicy Additions**:
  - `manageChildAccount()`: Check if reseller can manage a child
  - `viewResellerDashboard()`: Check if user can access reseller dashboard
  - `assignChildAccount()`: Check if user can assign child accounts

## Reseller Signup Workflow

### Step 1: Application Submission

Potential resellers visit the signup page and submit an application:

```
Route: /reseller/signup
Method: GET/POST
```

**Required Information:**
- Name, Email, Phone
- Password (account credentials)
- Business Name
- Business Address
- Business Type (individual/company)
- Expected number of customers
- Terms acceptance

### Step 2: Admin Review

Administrators can view pending applications:

```
Route: /panel/reseller/applications
Method: GET
```

For each application, admin can:
- View full application details
- Approve with custom commission rate
- Reject with reason

### Step 3: Approval/Rejection

**Approval Process:**
```php
POST /panel/reseller/applications/{id}/approve

Required Fields:
- commission_rate: decimal (0.00 to 1.00)
- notes: optional string
```

**Rejection Process:**
```php
POST /panel/reseller/applications/{id}/reject

Required Fields:
- rejection_reason: required string
```

### Step 4: Reseller Access

Once approved, resellers can:
- Log in to their account
- Access reseller dashboard
- Manage child accounts
- View commission reports

## Using Reseller Features

### Creating Child Accounts

Resellers can create customer accounts that are automatically linked as children:

```php
// When creating a customer as a reseller
$customer = User::create([
    'parent_id' => auth()->id(),  // Current reseller ID
    // ... other customer fields
]);
```

### Viewing Child Accounts

```php
// Get all child accounts
$reseller = auth()->user();
$children = $reseller->childAccounts;

// Count active children
$activeChildren = $reseller->childAccounts()
    ->where('status', 'active')
    ->count();
```

### Calculating Commission

```php
use App\Services\ResellerBillingService;

$billingService = app(ResellerBillingService::class);

// Calculate revenue for current month
$revenueData = $billingService->calculateChildAccountsRevenue(
    $reseller,
    now()->startOfMonth()->toDateString(),
    now()->toDateString()
);

/*
Returns:
[
    'total_revenue' => 5000.00,
    'total_payments' => 25,
    'commission' => 750.00,      // Based on commission_rate
    'commission_rate' => 0.15,
    'child_count' => 10,
    'breakdown' => [...],
]
*/
```

### Generating Commission Reports

```php
$report = $billingService->generateCommissionReport(
    $reseller,
    $startDate,
    $endDate
);

/*
Returns:
[
    'reseller_id' => 123,
    'reseller_name' => 'ABC Resellers',
    'report_period' => [...],
    'summary' => [
        'total_child_accounts' => 10,
        'total_revenue' => 5000.00,
        'commission_rate' => '15%',
        'total_commission' => 750.00,
        'total_payments' => 25,
    ],
    'child_accounts_breakdown' => [...],
]
*/
```

## Reseller Dashboard

### Accessing the Dashboard

```
Route: /reseller/dashboard
Method: GET
Authorization: Must be approved reseller
```

### Dashboard Widgets

1. **Child Accounts Summary**
   - Total child accounts
   - Active vs inactive
   - Recent signups

2. **Revenue Overview**
   - Current month revenue
   - Previous month comparison
   - Revenue trends

3. **Commission Summary**
   - Earned commission (current month)
   - Total lifetime commission
   - Pending payments

4. **Top Performing Customers**
   - Highest revenue generators
   - Most active customers
   - Payment frequency

### Commission Report

```
Route: /reseller/commission-report
Method: GET
Parameters: start_date, end_date
```

Report includes:
- Revenue breakdown per child account
- Payment count per customer
- Commission calculation details
- Downloadable PDF/Excel export

## Permission Management

### Reseller Permissions

Resellers can:
- ✅ View their child accounts
- ✅ Create new child accounts
- ✅ Edit child account details
- ✅ View child account payments
- ✅ Suspend/activate child accounts (if granted)
- ✅ Send SMS/notifications to children
- ✅ Generate reports for their children

Resellers cannot:
- ❌ View accounts of other resellers
- ❌ Delete child accounts
- ❌ Access admin functions
- ❌ Modify commission rates
- ❌ Approve other reseller applications
- ❌ Access system settings

### Checking Permissions

```php
// In controllers
if ($user->can('manageChildAccount', $customer)) {
    // Reseller can manage this customer
}

// In Blade
@can('manageChildAccount', $customer)
    <!-- Show management options -->
@endcan

// In Policy
public function manageChildAccount(User $reseller, User $customer): bool
{
    return $customer->parent_id === $reseller->id;
}
```

## Commission Management

### Setting Commission Rates

Commission rates are set during approval or can be updated later:

```php
// During approval
$reseller->update([
    'commission_rate' => 0.15,  // 15%
]);

// Bulk update for multiple resellers
User::where('is_reseller', true)
    ->where('reseller_status', 'approved')
    ->update(['commission_rate' => 0.12]);
```

### Commission Tiers

You can implement tiered commissions based on performance:

```php
public function getCommissionRate(User $reseller): float
{
    $childCount = $reseller->childAccounts()->count();
    
    return match(true) {
        $childCount >= 50 => 0.20,  // 20% for 50+ customers
        $childCount >= 25 => 0.15,  // 15% for 25+ customers
        $childCount >= 10 => 0.12,  // 12% for 10+ customers
        default => 0.10,            // 10% for < 10 customers
    };
}
```

### Paying Commissions

```php
$billingService->payCommission(
    $reseller,
    750.00,
    'Commission for January 2026'
);

// Creates a payment record
Payment::create([
    'user_id' => $reseller->id,
    'amount' => 750.00,
    'payment_method' => 'commission',
    'status' => 'completed',
    'description' => 'Commission for January 2026',
]);
```

## Nested Reseller Hierarchy

The system supports multi-level reseller hierarchies:

```
Super Reseller (Level 1)
  ├── Sub-Reseller A (Level 2)
  │   ├── Customer 1
  │   └── Customer 2
  ├── Sub-Reseller B (Level 2)
  │   ├── Customer 3
  │   └── Customer 4
  └── Customer 5 (Direct)
```

### Commission Distribution

For nested hierarchies, implement commission splitting:

```php
public function distributeCommission(Payment $payment): void
{
    $customer = $payment->user;
    $amount = $payment->amount;
    
    // Level 1: Direct parent gets primary commission
    if ($customer->parent) {
        $directCommission = $amount * $customer->parent->commission_rate;
        $this->payCommission($customer->parent, $directCommission);
        
        // Level 2: Grandparent gets override commission
        if ($customer->parent->parent) {
            $overrideRate = 0.05; // 5% override
            $overrideCommission = $amount * $overrideRate;
            $this->payCommission($customer->parent->parent, $overrideCommission);
        }
    }
}
```

## Best Practices

### Security

1. **Validate Reseller Status**: Always check `reseller_status === 'approved'`
2. **Verify Parent-Child Relationships**: Ensure resellers can only access their children
3. **Audit Trail**: Log all reseller actions
4. **Rate Limiting**: Implement rate limits on reseller APIs

### Performance

1. **Cache Child Counts**: Cache the number of child accounts
2. **Eager Load Relationships**: Use `with('childAccounts')` to avoid N+1 queries
3. **Index Database**: Add indexes on `parent_id` and `is_reseller` columns
4. **Paginate Results**: Always paginate large result sets

### User Experience

1. **Clear Onboarding**: Provide clear instructions for new resellers
2. **Help Documentation**: Include help links throughout the reseller interface
3. **Email Notifications**: Notify resellers of important events
4. **Commission Transparency**: Show clear commission calculations

## Troubleshooting

### Reseller Cannot See Child Accounts

**Possible Causes:**
- Reseller status is not 'approved'
- `parent_id` not set correctly on child accounts
- Permission issues

**Solution:**
```php
// Check reseller status
$reseller->reseller_status === 'approved'

// Verify child accounts
$reseller->childAccounts()->count()

// Check permissions
$reseller->can('viewResellerDashboard', User::class)
```

### Commission Calculations Incorrect

**Possible Causes:**
- Incorrect commission rate
- Wrong date range
- Missing payments

**Solution:**
```php
// Verify commission rate
$reseller->commission_rate

// Check payment records
Payment::where('user_id', $childId)
    ->where('status', 'completed')
    ->whereBetween('created_at', [$startDate, $endDate])
    ->sum('amount')
```

### Application Stuck in Pending

**Solution:**
```php
// Manually approve
$reseller->update([
    'reseller_status' => 'approved',
    'status' => 'active',
    'commission_rate' => 0.10,
    'reseller_approved_at' => now(),
]);
```

## API Endpoints

```
# Reseller Signup
POST /reseller/signup
Body: {name, email, phone, password, business_name, ...}

# Admin: List Applications
GET /panel/reseller/applications

# Admin: View Application
GET /panel/reseller/applications/{id}

# Admin: Approve Application
POST /panel/reseller/applications/{id}/approve
Body: {commission_rate, notes}

# Admin: Reject Application
POST /panel/reseller/applications/{id}/reject
Body: {rejection_reason}

# Reseller: Dashboard
GET /reseller/dashboard

# Reseller: Commission Report
GET /reseller/commission-report?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
```

## Future Enhancements

- [ ] Automated commission payments
- [ ] Reseller performance analytics
- [ ] Marketing materials for resellers
- [ ] Reseller portal mobile app
- [ ] White-label branding options
- [ ] Reseller training modules
- [ ] Automated commission tier adjustments

---

For additional support or questions, please contact the development team.
